<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Confirm subscription</title>
</head>

<body>
  <h2 id="status">Confirming...</h2>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIGMoObgso0mzHqm9P3i2i2BUuEJKHrQI",
      authDomain: "weatherapp-0101.firebaseapp.com",
      projectId: "weatherapp-0101",
      storageBucket: "weatherapp-0101.firebasestorage.app",
      messagingSenderId: "1085786149065",
      appId: "1:1085786149065:web:037743a6e2cea018cf7d18"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function getParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    async function run() {
      const token = getParam("token");
      const status = document.getElementById("status");
      if (!token) {
        status.textContent = "Missing token";
        return;
      }

      await signInAnonymously(auth);

      const q = query(collection(db, "subscribers"), where("token", "==", token));
      const snap = await getDocs(q);
      if (snap.empty) {
        status.textContent = "Invalid token";
        return;
      }
      const docRef = snap.docs[0].ref;
      await updateDoc(docRef, { confirmed: true });
      status.textContent = "âœ… Subscription confirmed!";
    }

    run().catch(e => {
      document.getElementById("status").textContent = "Error: " + e;
      console.error(e);
    });
  </script>
</body>

</html>